<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI System Controller - Chat Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .glass-dark {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(71, 85, 105, 0.5);
        }
        
        .code-editor {
            font-family: 'Courier New', monospace;
            background: #0f172a;
            color: #10b981;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .message-user {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }
        
        .message-ai {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        
        .message-system {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .message-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .typing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3b82f6;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-indicator:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen">
    <div id="app" class="min-h-screen p-4">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h1 class="text-3xl font-bold gradient-text">AI System Controller</h1>
                        <p class="text-slate-400">Chat with AI to control and update your avatar system</p>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <div id="connectionStatus" class="w-3 h-3 rounded-full bg-red-500"></div>
                            <span class="text-sm text-slate-300">Disconnected</span>
                        </div>
                        
                        <input
                            id="serverIP"
                            type="text"
                            value="localhost:8080"
                            placeholder="Server IP:Port"
                            class="bg-slate-700 border border-slate-600 rounded px-3 py-1 text-sm"
                        />
                        
                        <button
                            id="connectBtn"
                            class="bg-slate-700 border border-slate-600 rounded px-3 py-1 text-sm hover:bg-slate-600 flex items-center gap-1"
                        >
                            <i data-lucide="terminal" class="w-4 h-4"></i>
                            Connect
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Chat Panel -->
                <div class="glass-dark rounded-lg">
                    <div class="p-4 border-b border-slate-700/50">
                        <div class="flex items-center gap-2">
                            <i data-lucide="terminal" class="w-5 h-5 text-blue-400"></i>
                            <h2 class="text-lg font-semibold text-white">AI Chat</h2>
                            <span id="messageCount" class="bg-blue-500/10 text-blue-400 border border-blue-500/30 rounded px-2 py-1 text-xs ml-auto">
                                0 messages
                            </span>
                        </div>
                    </div>
                    
                    <div class="p-0">
                        <!-- Messages -->
                        <div id="messages" class="h-96 overflow-y-auto p-4 space-y-3">
                            <!-- Messages will be added here dynamically -->
                        </div>

                        <!-- Input Area -->
                        <div class="p-4 border-t border-slate-700/50">
                            <div class="flex gap-2 mb-3">
                                <input
                                    id="fileInput"
                                    type="file"
                                    multiple
                                    class="hidden"
                                />
                                <button
                                    id="uploadBtn"
                                    class="bg-slate-700/50 border border-slate-600 rounded px-3 py-1 text-sm hover:bg-slate-600 flex items-center gap-1"
                                >
                                    <i data-lucide="upload" class="w-4 h-4"></i>
                                    Upload Files
                                </button>
                                
                                <button
                                    id="clearBtn"
                                    class="bg-slate-700/50 border border-slate-600 rounded px-3 py-1 text-sm hover:bg-slate-600 flex items-center gap-1"
                                >
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                    Clear
                                </button>
                            </div>

                            <div class="flex gap-2">
                                <textarea
                                    id="messageInput"
                                    placeholder="Type your command or instruction here..."
                                    class="flex-1 bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white placeholder-slate-400 resize-none"
                                    rows="3"
                                ></textarea>
                                <button
                                    id="sendBtn"
                                    class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2 flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    <i data-lucide="send" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Code Generation Panel -->
                <div class="glass-dark rounded-lg">
                    <div class="p-4 border-b border-slate-700/50">
                        <div class="flex items-center gap-2">
                            <i data-lucide="code" class="w-5 h-5 text-green-400"></i>
                            <h2 class="text-lg font-semibold text-white">Generated Code</h2>
                            <span id="codeStatus" class="bg-green-500/10 text-green-400 border border-green-500/30 rounded px-2 py-1 text-xs ml-auto">
                                Empty
                            </span>
                        </div>
                    </div>
                    
                    <div class="p-4 space-y-4">
                        <!-- Code Editor -->
                        <div class="code-editor h-64 overflow-auto">
                            <div id="generatedCode">// Generated code will appear here...
// Send a command to the AI to generate code</div>
                        </div>

                        <!-- Uploaded Files -->
                        <div id="uploadedFiles" class="hidden">
                            <h4 class="text-sm font-medium text-slate-300 mb-2">Uploaded Files</h4>
                            <div id="fileList" class="space-y-2">
                                <!-- Files will be added here dynamically -->
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-2">
                            <button
                                id="pushBtn"
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white rounded px-4 py-2 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <i data-lucide="play" class="w-4 h-4"></i>
                                Push Update
                            </button>
                            
                            <button
                                id="clearCodeBtn"
                                class="bg-slate-700/50 border border-slate-600 rounded px-3 py-2 hover:bg-slate-600"
                            >
                                <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                            </button>
                        </div>

                        <!-- Status -->
                        <div class="text-center">
                            <p id="statusText" class="text-sm text-slate-400">
                                Connect to server to start
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ChatInterface {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.messages = [];
                this.uploadedFiles = [];
                this.generatedCode = '';
                this.messageCount = 0;
                
                this.initializeElements();
                this.attachEventListeners();
            }

            initializeElements() {
                this.connectionStatus = document.getElementById('connectionStatus');
                this.serverIP = document.getElementById('serverIP');
                this.connectBtn = document.getElementById('connectBtn');
                this.messagesContainer = document.getElementById('messages');
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.fileInput = document.getElementById('fileInput');
                this.uploadBtn = document.getElementById('uploadBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.generatedCodeEl = document.getElementById('generatedCode');
                this.pushBtn = document.getElementById('pushBtn');
                this.clearCodeBtn = document.getElementById('clearCodeBtn');
                this.statusText = document.getElementById('statusText');
                this.messageCountEl = document.getElementById('messageCount');
                this.codeStatusEl = document.getElementById('codeStatus');
                this.uploadedFilesEl = document.getElementById('uploadedFiles');
                this.fileListEl = document.getElementById('fileList');
            }

            attachEventListeners() {
                this.connectBtn.addEventListener('click', () => this.connectWebSocket());
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                this.uploadBtn.addEventListener('click', () => this.fileInput.click());
                this.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                this.clearBtn.addEventListener('click', () => this.clearChat());
                this.pushBtn.addEventListener('click', () => this.pushUpdate());
                this.clearCodeBtn.addEventListener('click', () => this.clearCode());
            }

            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${this.serverIP.value}`;
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('Connected to WebSocket server');
                    this.isConnected = true;
                    this.updateConnectionStatus(true);
                    this.addMessage('system', 'Connected to server', 'success');
                    
                    // Register as chat client
                    this.ws.send(JSON.stringify({
                        type: 'register',
                        clientType: 'chat-interface'
                    }));
                };

                this.ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    this.handleWebSocketMessage(message);
                };

                this.ws.onclose = () => {
                    console.log('Disconnected from WebSocket server');
                    this.isConnected = false;
                    this.updateConnectionStatus(false);
                    this.addMessage('system', 'Disconnected from server', 'error');
                    
                    // Attempt to reconnect after 3 seconds
                    setTimeout(() => {
                        if (!this.isConnected) {
                            this.connectWebSocket();
                        }
                    }, 3000);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.addMessage('system', 'Connection error', 'error');
                };
            }

            handleWebSocketMessage(message) {
                switch (message.type) {
                    case 'registered':
                        this.addMessage('system', 'Registered with server', 'success');
                        break;
                    case 'ai_response':
                        this.addMessage('ai', message.data.response, 'info');
                        break;
                    case 'code_generated':
                        this.generatedCode = message.data.code;
                        this.updateCodeDisplay();
                        this.addMessage('system', 'Code generated successfully', 'success');
                        break;
                    case 'update_pushed':
                        this.addMessage('system', `Update pushed: ${message.data.message}`, 'success');
                        break;
                    case 'error':
                        this.addMessage('system', `Error: ${message.data.error}`, 'error');
                        break;
                    default:
                        console.log('Unknown message type:', message.type);
                }
            }

            updateConnectionStatus(connected) {
                this.connectionStatus.className = `w-3 h-3 rounded-full ${connected ? 'bg-green-500' : 'bg-red-500'}`;
                this.connectionStatus.nextElementSibling.textContent = connected ? 'Connected' : 'Disconnected';
                this.statusText.textContent = connected ? 
                    'Ready to receive commands and push updates' : 
                    'Connect to server to start';
            }

            addMessage(sender, content, type = 'info') {
                const message = {
                    id: Date.now(),
                    sender,
                    content,
                    type,
                    timestamp: new Date().toLocaleTimeString()
                };
                
                this.messages.push(message);
                this.messageCount++;
                this.renderMessage(message);
                this.updateMessageCount();
                this.scrollToBottom();
            }

            renderMessage(message) {
                const messageEl = document.createElement('div');
                messageEl.className = 'flex gap-3';
                
                const icon = this.getMessageIcon(message.sender);
                const colorClass = this.getMessageColor(message.type);
                
                messageEl.innerHTML = `
                    <div class="text-2xl">${icon}</div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-medium text-slate-300">${this.getSenderName(message.sender)}</span>
                            <span class="text-xs text-slate-500">${message.timestamp}</span>
                        </div>
                        <p class="text-sm ${colorClass}">${message.content}</p>
                    </div>
                `;
                
                this.messagesContainer.appendChild(messageEl);
            }

            getMessageIcon(sender) {
                switch (sender) {
                    case 'user': return '👤';
                    case 'ai': return '🤖';
                    case 'system': return '⚙️';
                    default: return '💬';
                }
            }

            getSenderName(sender) {
                switch (sender) {
                    case 'user': return 'You';
                    case 'ai': return 'AI Assistant';
                    case 'system': return 'System';
                    default: return 'Unknown';
                }
            }

            getMessageColor(type) {
                switch (type) {
                    case 'success': return 'text-green-400';
                    case 'error': return 'text-red-400';
                    case 'warning': return 'text-yellow-400';
                    case 'info': return 'text-blue-400';
                    case 'user': return 'text-white';
                    default: return 'text-slate-300';
                }
            }

            updateMessageCount() {
                this.messageCountEl.textContent = `${this.messageCount} messages`;
            }

            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message || !this.isConnected) return;

                this.messageInput.value = '';
                this.addMessage('user', message, 'user');

                // Send message to server for AI processing
                this.ws.send(JSON.stringify({
                    type: 'ai_command',
                    data: {
                        command: message,
                        context: {
                            uploadedFiles: this.uploadedFiles.map(f => ({ name: f.name, type: f.type })),
                            systemState: this.isConnected ? 'connected' : 'disconnected',
                            timestamp: Date.now()
                        },
                        priority: 'normal'
                    }
                }));

                // Show typing indicator
                this.showTypingIndicator();
            }

            showTypingIndicator() {
                const typingEl = document.createElement('div');
                typingEl.className = 'flex gap-3';
                typingEl.innerHTML = `
                    <div class="text-2xl">🤖</div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-medium text-slate-300">AI Assistant</span>
                            <div class="flex gap-1">
                                <div class="typing-indicator"></div>
                                <div class="typing-indicator"></div>
                                <div class="typing-indicator"></div>
                            </div>
                        </div>
                        <p class="text-sm text-blue-400">Processing your request...</p>
                    </div>
                `;
                
                this.messagesContainer.appendChild(typingEl);
                this.scrollToBottom();

                // Remove typing indicator after 2 seconds
                setTimeout(() => {
                    if (typingEl.parentNode) {
                        typingEl.parentNode.removeChild(typingEl);
                    }
                }, 2000);
            }

            handleFileUpload(event) {
                const files = Array.from(event.target.files);
                files.forEach(file => {
                    const fileObj = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        file: file
                    };
                    this.uploadedFiles.push(fileObj);
                });
                
                this.updateFileList();
                this.addMessage('system', `Uploaded ${files.length} file(s)`, 'success');
            }

            updateFileList() {
                if (this.uploadedFiles.length === 0) {
                    this.uploadedFilesEl.classList.add('hidden');
                    return;
                }

                this.uploadedFilesEl.classList.remove('hidden');
                this.fileListEl.innerHTML = this.uploadedFiles.map(file => `
                    <div class="flex items-center justify-between p-2 bg-slate-700/50 rounded">
                        <div class="flex items-center gap-2">
                            <i data-lucide="file-text" class="w-4 h-4 text-blue-400"></i>
                            <span class="text-sm text-white">${file.name}</span>
                            <span class="text-xs text-slate-400">(${(file.size / 1024).toFixed(1)} KB)</span>
                        </div>
                        <button
                            onclick="chatInterface.removeFile('${file.id}')"
                            class="bg-red-600/20 border border-red-600/30 text-red-400 hover:bg-red-600/30 rounded px-2 py-1 text-sm"
                        >
                            ×
                        </button>
                    </div>
                `).join('');

                // Re-initialize Lucide icons
                lucide.createIcons();
            }

            removeFile(fileId) {
                this.uploadedFiles = this.uploadedFiles.filter(f => f.id !== fileId);
                this.updateFileList();
            }

            clearChat() {
                this.messages = [];
                this.messageCount = 0;
                this.messagesContainer.innerHTML = '';
                this.updateMessageCount();
            }

            updateCodeDisplay() {
                this.generatedCodeEl.textContent = this.generatedCode || '// Generated code will appear here...\n// Send a command to the AI to generate code';
                this.codeStatusEl.textContent = this.generatedCode ? 'Ready' : 'Empty';
                this.pushBtn.disabled = !this.generatedCode.trim() || !this.isConnected;
            }

            clearCode() {
                this.generatedCode = '';
                this.updateCodeDisplay();
            }

            pushUpdate() {
                if (!this.generatedCode.trim() || !this.isConnected) {
                    this.addMessage('system', 'No code to push or not connected', 'error');
                    return;
                }

                this.addMessage('system', 'Pushing update to system...', 'info');
                
                this.ws.send(JSON.stringify({
                    type: 'push_update',
                    data: {
                        code: this.generatedCode,
                        files: this.uploadedFiles.map(f => ({
                            name: f.name,
                            content: f.file // In real implementation, you'd read the file content
                        })),
                        timestamp: Date.now()
                    }
                }));
            }
        }

        // Initialize the chat interface when the page loads
        let chatInterface;
        document.addEventListener('DOMContentLoaded', () => {
            chatInterface = new ChatInterface();
            lucide.createIcons();
        });
    </script>
</body>
</html>
